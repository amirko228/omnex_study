import type { CourseFormat } from '@/types';
import type { Lesson } from '@/lib/api/mock-data';

/**
 * AI Content Adapter
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ–±—É—á–µ–Ω–∏—è
 */

export type AdaptedContent = {
  format: CourseFormat;
  content: string | React.ReactNode;
  title: string;
  description?: string;
  metadata?: {
    estimatedTime?: number;
    difficulty?: 'easy' | 'medium' | 'hard';
    aiGenerated?: boolean;
  };
};

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–∫ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç "text"
 */
function adaptToText(lesson: Lesson, originalContent?: string): AdaptedContent {
  const content = originalContent || lesson.content || `
# ${lesson.title}

## –í–≤–µ–¥–µ–Ω–∏–µ

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –≤—ã –∏–∑—É—á–∏—Ç–µ ${lesson.title.toLowerCase()}. –ú–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### –ß—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å

- **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è 1**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∫–ª—é—á–µ–≤–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
- **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è 2**: –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä –≤—Ç–æ—Ä–æ–π –≤–∞–∂–Ω–æ–π —Ç–µ–º—ã  
- **–ö–æ–Ω—Ü–µ–ø—Ü–∏—è 3**: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π

## –ü—Ä–∏–º–µ—Ä—ã

\`\`\`javascript
// –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
function example() {
  console.log('AI –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å');
}
\`\`\`

## –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

‚úÖ –í—ã –∏–∑—É—á–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
‚úÖ –†–∞–∑–æ–±—Ä–∞–ª–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
‚úÖ –ì–æ—Ç–æ–≤—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

–î–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏.
`;

  return {
    format: 'text',
    content,
    title: lesson.title,
    description: '–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏',
    metadata: {
      estimatedTime: lesson.duration,
      aiGenerated: true,
    },
  };
}

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–∫ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç "quiz"
 */
function adaptToQuiz(lesson: Lesson): AdaptedContent {
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã —É—Ä–æ–∫–∞
  const questions = [
    {
      id: 'q1',
      question: `–ö–∞–∫–∞—è –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–º–µ "${lesson.title}"?`,
      options: [
        '–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã',
        '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ',
        '–û–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–µ—Ä–Ω—ã',
        '–ù–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤',
      ],
      correctAnswer: 2,
      explanation: '–ò–ò –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª –≤–æ–ø—Ä–æ—Å –ø–æ–¥ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∑–Ω–∞–Ω–∏–π. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ç–µ–æ—Ä–∏—é –∏ –ø—Ä–∞–∫—Ç–∏–∫—É.',
    },
    {
      id: 'q2',
      question: '–í –∫–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è?',
      options: [
        '–¢–æ–ª—å–∫–æ –≤ —É—á–µ–±–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö',
        '–í —Ä–µ–∞–ª—å–Ω—ã—Ö production –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö',
        '–í –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ä–∞–±–æ—Ç–µ',
        '–í–æ –≤—Å–µ—Ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö',
      ],
      correctAnswer: 3,
      explanation: '–ó–Ω–∞–Ω–∏—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö.',
    },
    {
      id: 'q3',
      question: '–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã?',
      options: [
        '–ù–∞—á–∞–ª—å–Ω—ã–π',
        '–°—Ä–µ–¥–Ω–∏–π',
        '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π',
        '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π',
      ],
      correctAnswer: 1,
      explanation: `–ò–ò –æ–ø—Ä–µ–¥–µ–ª–∏–ª –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è —Ç–µ–º—ã "${lesson.title}".`,
    },
  ];

  return {
    format: 'quiz',
    content: JSON.stringify(questions),
    title: `–¢–µ—Å—Ç: ${lesson.title}`,
    description: '–ò–ò —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞—à–∏—Ö –∑–Ω–∞–Ω–∏–π',
    metadata: {
      estimatedTime: Math.ceil(lesson.duration * 0.5), // —Ç–µ—Å—Ç—ã –±—ã—Å—Ç—Ä–µ–µ
      aiGenerated: true,
    },
  };
}

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–∫ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç "chat"
 */
function adaptToChat(lesson: Lesson): AdaptedContent {
  const systemPrompt = `
–í—ã - AI —É—á–∏—Ç–µ–ª—å, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ç–µ–º–µ: "${lesson.title}".

–í–∞—à–∞ –∑–∞–¥–∞—á–∞:
- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º
- –ü—Ä–∏–≤–æ–¥–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –ø–æ–Ω–∏–º–∞–Ω–∏—è
- –ü–æ–æ—â—Ä—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ

–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞: ${lesson.title}
–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–∞: ${lesson.duration} –º–∏–Ω—É—Ç
`;

  const initialMessages = [
    {
      role: 'assistant',
      content: `–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –ø–æ —Ç–µ–º–µ "${lesson.title}". –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã - —è –∞–¥–∞–ø—Ç–∏—Ä—É—é –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å! ü§ñ`,
    },
    {
      role: 'assistant',
      content: `–ù–∞–ø—Ä–∏–º–µ—Ä, –≤—ã –º–æ–∂–µ—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å:\n‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ ${lesson.title}?\n‚Ä¢ –ö–∞–∫ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?\n‚Ä¢ –ö–∞–∫–∏–µ –µ—Å—Ç—å –ø—Ä–∏–º–µ—Ä—ã?`,
    },
  ];

  return {
    format: 'chat',
    content: JSON.stringify({ systemPrompt, initialMessages }),
    title: `–ß–∞—Ç: ${lesson.title}`,
    description: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º',
    metadata: {
      estimatedTime: lesson.duration,
      aiGenerated: true,
    },
  };
}

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —É—Ä–æ–∫ –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç "assignment"
 */
function adaptToAssignment(lesson: Lesson): AdaptedContent {
  const assignment = {
    title: `–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ${lesson.title}`,
    description: `–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ. –ò–ò –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –∏ –¥–∞—Å—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.`,
    tasks: [
      {
        id: 't1',
        title: '–ó–∞–¥–∞—á–∞ 1: –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è',
        description: `–°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ü–µ–ø—Ü–∏–π –∏–∑ —Ç–µ–º—ã "${lesson.title}"`,
        difficulty: 'easy',
        estimatedTime: Math.ceil(lesson.duration * 0.3),
      },
      {
        id: 't2',
        title: '–ó–∞–¥–∞—á–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å',
        description: '–î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏',
        difficulty: 'medium',
        estimatedTime: Math.ceil(lesson.duration * 0.5),
      },
      {
        id: 't3',
        title: '–ó–∞–¥–∞—á–∞ 3: –¢–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ',
        description: '–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π',
        difficulty: 'hard',
        estimatedTime: Math.ceil(lesson.duration * 0.7),
      },
    ],
    aiChecking: {
      enabled: true,
      criteria: [
        '–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è',
        '–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞',
        '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ best practices',
        '–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–¥—Ö–æ–¥–∞',
      ],
    },
    submission: {
      type: 'code' as const,
      language: 'javascript',
      template: `// –í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è "${lesson.title}"\n\nfunction solution() {\n  // TODO: –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ\n}\n\n// –ò–ò –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à –∫–æ–¥`,
    },
  };

  return {
    format: 'assignment',
    content: JSON.stringify(assignment),
    title: `–ó–∞–¥–∞–Ω–∏–µ: ${lesson.title}`,
    description: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π —Å AI –ø—Ä–æ–≤–µ—Ä–∫–æ–π',
    metadata: {
      estimatedTime: lesson.duration * 2, // –∑–∞–¥–∞–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
      difficulty: 'medium',
      aiGenerated: true,
    },
  };
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
 * @param lesson - –ò—Å—Ö–æ–¥–Ω—ã–π —É—Ä–æ–∫
 * @param format - –¶–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
 * @returns –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
 */
export async function adaptLessonContent(
  lesson: Lesson,
  format: CourseFormat
): Promise<AdaptedContent> {
  // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É AI –æ–±—Ä–∞–±–æ—Ç–∫–∏
  await new Promise((resolve) => setTimeout(resolve, 800));

  switch (format) {
    case 'text':
      return adaptToText(lesson);
    case 'quiz':
      return adaptToQuiz(lesson);
    case 'chat':
      return adaptToChat(lesson);
    case 'assignment':
      return adaptToAssignment(lesson);
    default:
      return adaptToText(lesson);
  }
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è UI
 */
export function getFormatDescription(format: CourseFormat): string {
  const descriptions = {
    text: '–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Å—Ö–µ–º–∞–º–∏',
    quiz: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞–Ω–∏–π',
    chat: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è',
    assignment: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è —Å AI –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ—à–µ–Ω–∏–π',
  };
  return descriptions[format];
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏–∫–æ–Ω–∫—É —Ñ–æ—Ä–º–∞—Ç–∞
 */
export function getFormatIcon(format: CourseFormat): string {
  const icons = {
    text: 'üìù',
    quiz: '‚úÖ',
    chat: 'üí¨',
    assignment: 'üìã',
  };
  return icons[format];
}
