// ============================================================================
// PRISMA SCHEMA - AI Learning Platform
// Полная схема БД для всех модулей платформы
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ПОЛЬЗОВАТЕЛИ И АУТЕНТИФИКАЦИЯ
// ============================================================================

/// Основная таблица пользователей
model User {
  id                String    @id @default(uuid()) @db.Uuid
  email             String    @unique @db.VarChar(255)
  passwordHash      String?   @map("password_hash") @db.VarChar(255)
  name              String    @db.VarChar(255)
  avatar            String?
  role              String    @default("user") @db.VarChar(50) // user | admin
  locale            String    @default("ru") @db.VarChar(10)
  emailVerified     Boolean   @default(false) @map("email_verified")
  twoFactorEnabled  Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?   @map("two_factor_secret") @db.VarChar(255)
  subscriptionPlan  String    @default("free") @map("subscription_plan") @db.VarChar(50)
  bio               String?
  phone             String?   @db.VarChar(50)
  country           String?   @db.VarChar(100)
  timezone          String?   @db.VarChar(100)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  // Связи
  oauthAccounts          OAuthAccount[]
  refreshTokens          RefreshToken[]
  passwordResetTokens    PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  courses                Course[]       @relation("AuthorCourses")
  enrollments            Enrollment[]
  progress               UserProgress[]
  reviews                Review[]
  subscriptions          Subscription[]
  payments               Payment[]
  aiChats                AIChat[]
  notifications          Notification[]
  analyticsEvents        AnalyticsEvent[]
  auditLogs              AuditLog[]
  quizAttempts           QuizAttempt[]

  @@map("users")
}

/// OAuth аккаунты (Google, VK, Yandex)
model OAuthAccount {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  provider          String   @db.VarChar(50) // google | vk | yandex
  providerAccountId String   @map("provider_account_id") @db.VarChar(255)
  accessToken       String?  @map("access_token")
  refreshToken      String?  @map("refresh_token")
  expiresAt         BigInt?  @map("expires_at")
  createdAt         DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("oauth_accounts")
}

/// Refresh-токены для JWT
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

/// Токены сброса пароля
model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

/// Токены верификации email
model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

// ============================================================================
// КУРСЫ И КОНТЕНТ
// ============================================================================

/// Курсы
model Course {
  id                 String    @id @default(uuid()) @db.Uuid
  title              String    @db.VarChar(500)
  description        String?
  slug               String?   @unique @db.VarChar(255)
  instructorName     String?   @map("instructor_name") @db.VarChar(255)
  authorId           String?   @map("author_id") @db.Uuid
  thumbnail          String?
  coverImage         String?   @map("cover_image")
  category           String?   @db.VarChar(100)
  tags               String[]  // PostgreSQL array
  level              String?   @db.VarChar(50) // beginner | intermediate | advanced
  language           String    @default("ru") @db.VarChar(10)
  availableLanguages String[]  @map("available_languages")
  durationMinutes    Int?      @map("duration_minutes")
  price              Decimal   @default(0) @db.Decimal(10, 2)
  currency           String    @default("USD") @db.VarChar(10)
  isPublished        Boolean   @default(false) @map("is_published")
  isFeatured         Boolean   @default(false) @map("is_featured")
  isAIGenerated      Boolean   @default(false) @map("is_ai_generated")
  rating             Decimal   @default(0) @db.Decimal(3, 2)
  reviewsCount       Int       @default(0) @map("reviews_count")
  enrolledCount      Int       @default(0) @map("enrolled_count")
  formats            String[]  // text | quiz | chat | assignment
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Связи
  author        User?            @relation("AuthorCourses", fields: [authorId], references: [id])
  modules       CourseModule[]
  enrollments   Enrollment[]
  reviews       Review[]
  payments      Payment[]
  aiChats       AIChat[]
  aiGenerated   AIGeneratedCourse[]

  @@index([category])
  @@index([level])
  @@index([isPublished])
  @@map("courses")
}

/// Модули курса (разделы)
model CourseModule {
  id              String   @id @default(uuid()) @db.Uuid
  courseId         String   @map("course_id") @db.Uuid
  title           String   @db.VarChar(500)
  description     String?
  orderIndex      Int      @map("order_index")
  durationMinutes Int?     @map("duration_minutes")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Связи
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@map("course_modules")
}

/// Уроки
model Lesson {
  id              String   @id @default(uuid()) @db.Uuid
  moduleId        String   @map("module_id") @db.Uuid
  title           String   @db.VarChar(500)
  type            String   @db.VarChar(50) // text | quiz | assignment | chat
  format          String   @default("text") @db.VarChar(50)
  content         String?
  durationMinutes Int?     @map("duration_minutes")
  orderIndex      Int      @map("order_index")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Связи
  module   CourseModule    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes  Quiz[]
  progress UserProgress[]
  aiChats  AIChat[]

  @@index([moduleId])
  @@map("lessons")
}

/// Тесты (квизы)
model Quiz {
  id               String   @id @default(uuid()) @db.Uuid
  lessonId         String   @map("lesson_id") @db.Uuid
  title            String?  @db.VarChar(500)
  description      String?
  passingScore     Int      @default(70) @map("passing_score")
  timeLimitMinutes Int?     @map("time_limit_minutes")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Связи
  lesson    Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@map("quizzes")
}

/// Вопросы теста
model QuizQuestion {
  id            String   @id @default(uuid()) @db.Uuid
  quizId        String   @map("quiz_id") @db.Uuid
  question      String
  options       Json     // ['option1', 'option2', ...]
  correctAnswer Int      @map("correct_answer")
  explanation   String?
  points        Int      @default(1)
  orderIndex    Int?     @map("order_index")
  createdAt     DateTime @default(now()) @map("created_at")

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

/// Попытки прохождения теста
model QuizAttempt {
  id          String   @id @default(uuid()) @db.Uuid
  quizId      String   @map("quiz_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  answers     Json     // {questionId: answerIndex}
  score       Int
  passed      Boolean
  completedAt DateTime @default(now()) @map("completed_at")

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
  @@map("quiz_attempts")
}

// ============================================================================
// ПРОГРЕСС И ЗАПИСИ НА КУРСЫ
// ============================================================================

/// Записи на курсы
model Enrollment {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  courseId    String   @map("course_id") @db.Uuid
  enrolledAt DateTime @default(now()) @map("enrolled_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

/// Прогресс пользователя по урокам
model UserProgress {
  id               String    @id @default(uuid()) @db.Uuid
  userId           String    @map("user_id") @db.Uuid
  lessonId         String    @map("lesson_id") @db.Uuid
  isCompleted      Boolean   @default(false) @map("is_completed")
  completedAt      DateTime? @map("completed_at")
  timeSpentMinutes Int       @default(0) @map("time_spent_minutes")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@map("user_progress")
}

// ============================================================================
// ОТЗЫВЫ
// ============================================================================

/// Отзывы на курсы
model Review {
  id        String   @id @default(uuid()) @db.Uuid
  courseId   String   @map("course_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
  @@map("reviews")
}

// ============================================================================
// ПОДПИСКИ И ПЛАТЕЖИ
// ============================================================================

/// Подписки пользователей
model Subscription {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  plan       String    @db.VarChar(50) // free | pro | enterprise
  status     String    @default("active") @db.VarChar(50) // active | canceled | expired
  startedAt  DateTime  @default(now()) @map("started_at")
  expiresAt  DateTime? @map("expires_at")
  canceledAt DateTime? @map("canceled_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@map("subscriptions")
}

/// Платежи
model Payment {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  subscriptionId    String?  @map("subscription_id") @db.Uuid
  courseId           String?  @map("course_id") @db.Uuid
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("USD") @db.VarChar(10)
  provider          String?  @db.VarChar(50) // stripe | cloudpayments | yoomoney
  providerPaymentId String?  @map("provider_payment_id") @db.VarChar(255)
  status            String   @default("pending") @db.VarChar(50) // pending | completed | failed | refunded
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user         User          @relation(fields: [userId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  course       Course?       @relation(fields: [courseId], references: [id])

  @@index([userId])
  @@map("payments")
}

/// Промокоды
model PromoCode {
  id              String    @id @default(uuid()) @db.Uuid
  code            String    @unique @db.VarChar(50)
  discountPercent Int?      @map("discount_percent")
  discountAmount  Decimal?  @map("discount_amount") @db.Decimal(10, 2)
  validFrom       DateTime? @map("valid_from")
  validUntil      DateTime? @map("valid_until")
  maxUses         Int?      @map("max_uses")
  currentUses     Int       @default(0) @map("current_uses")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("promo_codes")
}

// ============================================================================
// AI ФУНКЦИИ
// ============================================================================

/// AI чаты (с наставником, генерация курсов)
model AIChat {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  courseId   String?  @map("course_id") @db.Uuid
  lessonId  String?  @map("lesson_id") @db.Uuid
  type      String?  @db.VarChar(50) // tutor | course_creation | general
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course?     @relation(fields: [courseId], references: [id])
  lesson   Lesson?     @relation(fields: [lessonId], references: [id])
  messages AIMessage[]

  @@map("ai_chats")
}

/// Сообщения в AI чате
model AIMessage {
  id        String   @id @default(uuid()) @db.Uuid
  chatId    String   @map("chat_id") @db.Uuid
  role      String   @db.VarChar(50) // user | assistant | system
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  chat AIChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@map("ai_messages")
}

/// Логи AI-сгенерированных курсов
model AIGeneratedCourse {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String?  @map("user_id") @db.Uuid
  courseId          String?  @map("course_id") @db.Uuid
  prompt           String
  generationParams Json?    @map("generation_params")
  tokensUsed       Int?     @map("tokens_used")
  createdAt        DateTime @default(now()) @map("created_at")

  course Course? @relation(fields: [courseId], references: [id])

  @@map("ai_generated_courses")
}

// ============================================================================
// УВЕДОМЛЕНИЯ И АНАЛИТИКА
// ============================================================================

/// Уведомления
model Notification {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  type      String    @db.VarChar(50) // course_update | payment | reminder | marketing
  channel   String?   @db.VarChar(50) // email | push | in-app
  title     String?   @db.VarChar(500)
  message   String?
  data      Json?
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

/// События аналитики
model AnalyticsEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  eventType String   @map("event_type") @db.VarChar(100)
  eventData Json?    @map("event_data")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([eventType])
  @@index([createdAt])
  @@map("analytics_events")
}

/// Аудит логи
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(255)
  entityType String?  @map("entity_type") @db.VarChar(100)
  entityId   String?  @map("entity_id") @db.Uuid
  changes    Json?
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
